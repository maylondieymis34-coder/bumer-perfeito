<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Bumer</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/3843/3843015.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">

    <style>
        /* Base e Reset */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; width: 100%; overflow: hidden; background: #000; position: fixed; }
        
        #app { width: 100%; height: 100%; background: #F5F5F5; position: relative; display: flex; flex-direction: column; }
        .screen { display: none; width: 100%; height: 100%; flex-direction: column; position: absolute; top: 0; left: 0; }
        .active { display: flex !important; }
        
        /* Cabe√ßalho */
        .header { background: #fff; padding: 15px; text-align: center; font-family: 'Fredoka One', cursive; color: #9D4EDD; font-size: 22px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 50; flex-shrink: 0; }
        
        /* Grid do Radar */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px; overflow-y: auto; flex: 1; padding-bottom: 80px; }
        .card { background: #fff; border-radius: 20px; position: relative; border: 4px solid transparent; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.1); height: fit-content; }
        .card img { width: 100%; height: 140px; object-fit: cover; }
        .card b { display: block; padding: 10px; text-align: center; color: #FF4D8F; font-family: 'Fredoka One'; font-size: 18px; }
        .del-user { position: absolute; top: 8px; left: 8px; background: rgba(255, 0, 0, 0.8); color: white; border: none; border-radius: 50%; width: 28px; height: 28px; font-weight: bold; z-index: 20; }
        
        /* Chat - A PARTE QUE DAVA ERRO */
        .chat-container { display: flex; flex-direction: column; height: 100%; background: #E5DDD5; }
        .msgs { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; padding-bottom: 20px; }
        .msg { padding: 10px 15px; border-radius: 15px; max-width: 80%; font-size: 16px; word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .sent { align-self: flex-end; background: #DCF8C6; }
        .recv { align-self: flex-start; background: #fff; }
        .status { font-size: 11px; margin-left: 5px; color: #999; }
        .visto { color: #34B7F1 !important; }

        /* BARRA DE DIGITAR - FIXA E SEMPRE VIS√çVEL */
        .input-bar { 
            background: #fff; 
            padding: 10px 15px; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            border-top: 1px solid #ddd; 
            position: relative; 
            z-index: 100;
            padding-bottom: env(safe-area-inset-bottom, 15px);
        }
        .input-chat { 
            flex: 1; 
            padding: 12px 18px; 
            border-radius: 25px; 
            border: 1px solid #ddd; 
            outline: none; 
            font-size: 16px; 
            background: #f9f9f9;
            color: #333;
        }
        .send-btn { 
            background: linear-gradient(135deg, #FF4D8F, #9D4EDD); 
            color: #fff; 
            border: none; 
            width: 45px; 
            height: 45px; 
            border-radius: 50%; 
            font-weight: bold; 
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        /* Menu de Navega√ß√£o */
        .nav { position: fixed; bottom: 0; width: 100%; background: #fff; display: flex; justify-content: space-around; padding: 12px; border-top: 1px solid #ddd; z-index: 90; }
        .nav-btn { background: none; border: none; font-size: 24px; opacity: 0.3; }
        .nav-btn.active { opacity: 1; }

        /* Login */
        .login-screen { flex: 1; display: flex; flex-direction: column; justify-content: center; padding: 30px; text-align: center; background: #F5F5F5; }
        .logo { font-size: 50px; font-family: 'Fredoka One', cursive; background: linear-gradient(135deg, #FF8C42, #FF4D8F, #9D4EDD); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 30px; }
        
        /* Neon */
        .has-msg { animation: neon 0.8s infinite alternate; }
        @keyframes neon { 0% { border-color: #39FF14; box-shadow: 0 0 10px #39FF14; } 100% { border-color: #FF0000; box-shadow: 0 0 10px #FF0000; } }
    </style>
</head>
<body>

<div id="app">
    <div id="s-login" class="screen active">
        <div class="login-screen">
            <div class="logo">BUMER</div>
            <input type="text" id="nome" style="width:100%; padding:18px; border-radius:15px; border:2px solid #ddd; margin-bottom:15px; font-size:16px;" placeholder="Seu nome">
            <button style="width:100%; padding:18px; border-radius:15px; border:none; background:linear-gradient(135deg, #FF8C42, #9D4EDD); color:white; font-weight:bold; font-size:18px;" onclick="app.login()">ENTRAR AGORA</button>
        </div>
    </div>

    <div id="s-radar" class="screen">
        <div class="header">RADAR</div>
        <div class="grid" id="grid"></div>
        <div class="nav">
            <button class="nav-btn active" onclick="app.go('s-radar')">üß≠</button>
            <button class="nav-btn" onclick="app.go('s-perfil')">üë§</button>
        </div>
    </div>

    <div id="s-chat" class="screen">
        <div class="header" style="text-align:left; display:flex; align-items:center">
            <span onclick="app.go('s-radar')" style="margin-right:15px; font-size:25px; cursor:pointer">‚Üê</span>
            <span id="cn" style="color:#FF4D8F">Chat</span>
        </div>
        <div class="chat-container">
            <div class="msgs" id="ms"></div>
            <div class="input-bar">
                <input type="text" id="im" class="input-chat" placeholder="Digite aqui...">
                <button class="send-btn" onclick="app.send()">‚û§</button>
            </div>
        </div>
    </div>

    <div id="s-perfil" class="screen">
        <div class="header">PERFIL</div>
        <div style="text-align:center; padding:40px">
            <div id="fp" onclick="document.getElementById('file').click()" style="width:130px; height:130px; background:#ddd; border-radius:50%; margin:0 auto; overflow:hidden; border:4px solid #9D4EDD"></div>
            <input type="file" id="file" style="display:none" accept="image/*" onchange="app.upPhoto(this)">
            <h2 id="np" style="font-family:'Fredoka One'; margin-top:20px; color:#FF4D8F; font-size:28px"></h2>
            <button style="margin-top:40px; background:#ff3b30; color:white; border:none; padding:15px; border-radius:15px; width:100%; font-weight:bold" onclick="app.sair()">Sair da Conta</button>
        </div>
        <div class="nav">
            <button class="nav-btn" onclick="app.go('s-radar')">üß≠</button>
            <button class="nav-btn active" onclick="app.go('s-perfil')">üë§</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, setDoc, getDocs, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";

    const cfg = {
        apiKey: "AIzaSyA4IihfRLNToQ04yZVEamFDiz4mMwMVViE",
        authDomain: "bumer-app-6eee9.firebaseapp.com",
        projectId: "bumer-app-6eee9",
        storageBucket: "bumer-app-6eee9.firebasestorage.app",
        messagingSenderId: "574459437994",
        appId: "1:574459437994:web:e74ee1662e287866eac1d3"
    };

    const fb = initializeApp(cfg);
    const db = getFirestore(fb);

    window.app = {
        u: null, cId: null, sub: null,
        alert() {
            if (navigator.vibrate) navigator.vibrate(200);
            new Audio('https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3').play().catch(()=>{});
        },
        async login() {
            const n = document.getElementById('nome').value.trim();
            if(!n) return;
            this.u = { id: 'u'+Date.now(), nome: n, foto: '', deleted: [] };
            await setDoc(doc(db, "usuarios", this.u.id), this.u);
            localStorage.setItem('bumer_u', JSON.stringify(this.u));
            this.go('s-radar');
        },
        async load() {
            const g = document.getElementById('grid'); g.innerHTML = "Buscando...";
            const s = await getDocs(collection(db, "usuarios"));
            g.innerHTML = "";
            s.forEach(d => {
                const p = d.data();
                if(p.id == this.u.id || (this.u.deleted && this.u.deleted.includes(p.id))) return;
                const neon = p['msg_'+this.u.id] ? 'has-msg' : '';
                g.innerHTML += `<div class="card ${neon}" onclick="app.chat('${p.id}','${p.nome}')">
                    <button class="del-user" onclick="event.stopPropagation(); app.delUser('${p.id}')">X</button>
                    <img src="${p.foto || 'https://via.placeholder.com/150'}">
                    <b>${p.nome}</b>
                </div>`;
            });
        },
        async delUser(id) {
            if(confirm("Remover do Radar?")) {
                if(!this.u.deleted) this.u.deleted = [];
                this.u.deleted.push(id);
                await updateDoc(doc(db, "usuarios", this.u.id), { deleted: this.u.deleted });
                localStorage.setItem('bumer_u', JSON.stringify(this.u));
                this.load();
            }
        },
        async chat(id, n) {
            this.cId = id; document.getElementById('cn').innerText = n;
            await setDoc(doc(db, "usuarios", this.u.id), {['msg_'+id]:false}, {merge:true});
            this.go('s-chat'); this.listen();
        },
        listen() {
            if(this.sub) this.sub();
            const cid = [this.u.id, this.cId].sort().join('_');
            const q = query(collection(db, "chats", cid, "msgs"), orderBy("t", "asc"));
            this.sub = onSnapshot(q, (s) => {
                const m = document.getElementById('ms'); m.innerHTML = "";
                s.forEach(d => {
                    const i = d.data(); const isMe = i.sid == this.u.id;
                    if(!isMe && !i.lido) { updateDoc(doc(db,"chats",cid,"msgs",d.id), {lido:true}); this.alert(); }
                    m.innerHTML += `<div class="msg ${isMe?'sent':'recv'}" onclick="app.delMsg('${d.id}')">
                        ${i.txt} <span class="status ${i.lido?'visto':''}">${isMe?'‚úì‚úì':''}</span>
                    </div>`;
                });
                m.scrollTop = m.scrollHeight;
            });
        },
        async send() {
            const i = document.getElementById('im'); const txt = i.value.trim();
            if(!txt) return;
            const cid = [this.u.id, this.cId].sort().join('_');
            await addDoc(collection(db, "chats", cid, "msgs"), {
                txt: txt, sid: this.u.id, t: serverTimestamp() || Date.now(), lido: false
            });
            await setDoc(doc(db, "usuarios", this.cId), {['msg_'+this.u.id]:true}, {merge:true});
            i.value = "";
            i.focus(); // Mant√©m o teclado aberto
        },
        async delMsg(id) {
            if(confirm("Apagar mensagem?")) {
                const cid = [this.u.id, this.cId].sort().join('_');
                await deleteDoc(doc(db, "chats", cid, "msgs", id));
            }
        },
        go(s) {
            document.querySelectorAll('.screen').forEach(x => x.classList.remove('active'));
            document.getElementById(s).classList.add('active');
            if(s=='s-radar') this.load();
            if(s=='s-perfil') {
                document.getElementById('np').innerText = this.u.nome;
                document.getElementById('fp').innerHTML = this.u.foto ? `<img src="${this.u.foto}" style="width:100%;height:100%;object-fit:cover">` : '?';
            }
        },
        async upPhoto(el) {
            const r = new FileReader();
            r.onload = async (e) => {
                this.u.foto = e.target.result;
                await updateDoc(doc(db, "usuarios", this.u.id), {foto: this.u.foto});
                localStorage.setItem('bumer_u', JSON.stringify(this.u));
                this.go('s-perfil');
            };
            r.readAsDataURL(el.files[0]);
        },
        sair() { localStorage.clear(); location.reload(); }
    };

    window.onload = () => {
        const saved = localStorage.getItem('bumer_u');
        if(saved) { app.u = JSON.parse(saved); app.go('s-radar'); }
    };
</script>
</body>
</html>
