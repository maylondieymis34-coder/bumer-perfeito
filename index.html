<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bumer - Chat em Tempo Real</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f0f2f5; color: #333; }
    #login, #chat-area { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    input, button { padding: 10px; margin: 8px 0; border-radius: 5px; border: 1px solid #ddd; width: calc(100% - 22px); }
    button { background: #0084ff; color: white; border: none; cursor: pointer; }
    button:hover { background: #0066cc; }
    #messages { height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background: #fafafa; border-radius: 5px; margin-bottom: 10px; }
    .msg { margin: 8px 0; padding: 10px; border-radius: 10px; max-width: 80%; }
    .msg.sent { background: #0084ff; color: white; margin-left: auto; }
    .msg.received { background: #e5e5ea; margin-right: auto; }
    #profile-pic { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; }
    #status { color: #666; font-size: 0.9em; }
  </style>
</head>
<body>

  <!-- Área de Login -->
  <div id="login">
    <h2>Bumer - Entre no Chat</h2>
    <input id="username" placeholder="Seu nome (obrigatório)" required />
    <p>Escolha uma foto de perfil (opcional):</p>
    <input type="file" id="photo-input" accept="image/*" />
    <img id="preview" src="" alt="" style="width:100px; height:100px; border-radius:50%; display:none;" />
    <button onclick="entrar()">Entrar no Chat</button>
  </div>

  <!-- Área do Chat -->
  <div id="chat-area" style="display:none;">
    <div style="display:flex; align-items:center; gap:10px;">
      <img id="profile-pic" src="https://via.placeholder.com/60" alt="Sua foto" />
      <h2>Bumer Chat - <span id="meu-nome"></span></h2>
    </div>
    <div id="status">Conectado! Mande sua mensagem...</div>
    <div id="messages"></div>
    <div style="display:flex; gap:10px;">
      <input id="message-input" placeholder="Digite sua mensagem..." />
      <button onclick="enviarMensagem()">Enviar</button>
    </div>
  </div>

  <script type="module">
    // ================== FIREBASE CONFIG ==================
    // COLE AQUI SUA CONFIG DO FIREBASE (pegue no console.firebase.google.com)
    const firebaseConfig = {
      apiKey: "SUA_API_KEY_AQUI",
      authDomain: "SEU_PROJETO.firebaseapp.com",
      projectId: "SEU_PROJETO",
      storageBucket: "SEU_PROJETO.appspot.com",
      messagingSenderId: "SEU_SENDER_ID",
      appId: "SEU_APP_ID"
    };

    // ================== CLOUDINARY CONFIG ==================
    const CLOUD_NAME = "SEU_CLOUD_NAME_AQUI";           // ex: "demo" ou o seu
    const UPLOAD_PRESET = "bumer_unsigned";             // o nome do preset unsigned que você criou

    // ================== IMPORTS FIREBASE (CDN) ==================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, setDoc, doc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let userName = "";
    let photoUrl = "";

    // Preview da foto ao selecionar
    document.getElementById("photo-input").addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (ev) => {
          document.getElementById("preview").src = ev.target.result;
          document.getElementById("preview").style.display = "block";
        };
        reader.readAsDataURL(file);
      }
    });

    // Função para upload da foto pro Cloudinary
    async function uploadFoto(file) {
      if (!file) return null;

      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", UPLOAD_PRESET);

      try {
        const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
          method: "POST",
          body: formData
        });
        const data = await res.json();
        return data.secure_url || null;
      } catch (err) {
        console.error("Erro no upload da foto:", err);
        return null;
      }
    }

    // Entrar no chat
    async function entrar() {
      userName = document.getElementById("username").value.trim();
      if (!userName) {
        alert("Digite seu nome!");
        return;
      }

      document.getElementById("login").style.display = "none";
      document.getElementById("chat-area").style.display = "block";
      document.getElementById("meu-nome").textContent = userName;

      // Upload da foto se tiver
      const file = document.getElementById("photo-input").files[0];
      photoUrl = await uploadFoto(file);

      // Salva perfil no Firestore (pra persistir foto e nome)
      const userId = "user_" + userName.replace(/\s+/g, "_"); // ID simples baseado no nome (pra teste)
      await setDoc(doc(db, "users", userId), {
        name: userName,
        photo: photoUrl || "https://via.placeholder.com/60",
        lastSeen: serverTimestamp()
      }, { merge: true });

      // Mostra foto no chat
      document.getElementById("profile-pic").src = photoUrl || "https://via.placeholder.com/60";

      ouvirMensagens();
    }

    // Enviar mensagem
    async function enviarMensagem() {
      const input = document.getElementById("message-input");
      const texto = input.value.trim();
      if (!texto || !userName) return;

      try {
        await addDoc(collection(db, "messages"), {
          text: texto,
          user: userName,
          photo: photoUrl,
          createdAt: serverTimestamp()
        });
        input.value = "";
      } catch (e) {
        console.error("Erro ao enviar:", e);
      }
    }

    // Ouvir mensagens em tempo real
    function ouvirMensagens() {
      const q = query(collection(db, "messages"), orderBy("createdAt"));
      onSnapshot(q, (snapshot) => {
        const messagesDiv = document.getElementById("messages");
        messagesDiv.innerHTML = "";
        snapshot.forEach((doc) => {
          const msg = doc.data();
          const div = document.createElement("div");
          div.className = `msg ${msg.user === userName ? "sent" : "received"}`;
          div.innerHTML = `
            ${msg.photo ? `<img src="${msg.photo}" style="width:30px;height:30px;border-radius:50%;vertical-align:middle;margin-right:8px;">` : ""}
            <strong>${msg.user}:</strong> ${msg.text}
          `;
          messagesDiv.appendChild(div);
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      });
    }
  </script>
</body>
</html>
