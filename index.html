<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bumer - App de Conex√µes</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='75'>ü™É</text></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: white;
            overflow-x: hidden;
        }
        .screen { display: none; min-height: 100vh; }
        .screen.active { display: flex; }
        
        /* Splash Screen */
        #splash { flex-direction: column; align-items: center; justify-content: center; }
        .logo { 
            width: 100px; height: 100px; border-radius: 50%;
            background: linear-gradient(135deg, #FF8C42, #FF4D8F, #9D4EDD, #4CC9F0);
            display: flex; align-items: center; justify-content: center;
            font-size: 50px; animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        
        /* Header */
        .header {
            background: white;
            padding: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .header.gradient {
            background: linear-gradient(135deg, #FF8C42, #FF4D8F, #9D4EDD, #4CC9F0);
        }
        .header-title {
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(135deg, #FF8C42, #FF4D8F, #9D4EDD, #4CC9F0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .header-title.white { 
            background: white;
            -webkit-background-clip: text;
            -webkit-text-fill-color: white;
        }
        
        /* Signup */
        #signup {
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }
        input {
            width: 100%;
            max-width: 400px;
            padding: 16px;
            font-size: 18px;
            border: 2px solid #ddd;
            border-radius: 12px;
            margin: 12px 0;
        }
        input:focus { outline: none; border-color: #9D4EDD; }
        .btn {
            width: 100%;
            max-width: 400px;
            padding: 16px;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            background: linear-gradient(135deg, #FF8C42, #FF4D8F, #9D4EDD, #4CC9F0);
            color: white;
        }
        .btn:hover { opacity: 0.9; }
        
        /* Radar */
        .radar-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            padding: 16px;
            padding-bottom: 100px;
        }
        .user-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .user-card:hover { transform: scale(1.02); }
        .user-photo {
            width: 100%;
            height: 180px;
            object-fit: cover;
        }
        .user-avatar {
            width: 100%;
            height: 180px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            font-weight: bold;
            color: white;
        }
        .user-info {
            padding: 12px;
        }
        .user-icons {
            display: flex;
            gap: 4px;
            margin-top: 8px;
        }
        .icon-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }
        
        /* Conversations */
        .conv-list {
            overflow-y: auto;
            padding-bottom: 80px;
        }
        .conv-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .conv-item:hover { background: #f9f9f9; }
        .conv-avatar {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            object-fit: cover;
        }
        .avatar-circle {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            color: white;
        }
        
        /* Chat */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background: #f5f5f5;
        }
        .message {
            display: flex;
            margin-bottom: 12px;
        }
        .message.sent { justify-content: flex-end; }
        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 16px;
        }
        .message.sent .message-bubble {
            background: linear-gradient(135deg, #9D4EDD, #FF4D8F);
            color: white;
        }
        .message.received .message-bubble {
            background: white;
            color: #333;
        }
        .chat-input {
            display: flex;
            gap: 8px;
            padding: 16px;
            background: white;
            border-top: 1px solid #eee;
        }
        .chat-input input {
            flex: 1;
            margin: 0;
            border-radius: 24px;
        }
        .send-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #9D4EDD, #FF4D8F);
            color: white;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }
        
        /* Vault */
        .vault-list {
            padding: 16px;
            padding-bottom: 100px;
        }
        .vault-item {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 16px;
            margin-bottom: 16px;
        }
        .vault-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        .vault-avatar {
            filter: grayscale(100%);
            opacity: 0.5;
        }
        .vault-timer {
            background: #f5f5f5;
            padding: 12px;
            border-radius: 12px;
            text-align: center;
            font-family: monospace;
            margin-bottom: 12px;
        }
        .rescue-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #06FFA5, #4CC9F0);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
        }
        
        /* Profile */
        .profile-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }
        .profile-photo-container {
            position: relative;
            margin-bottom: 24px;
        }
        .profile-photo {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #9D4EDD;
        }
        .profile-avatar {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 64px;
            font-weight: bold;
            color: white;
            border: 4px solid #9D4EDD;
        }
        .photo-btn {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #9D4EDD;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 24px;
        }
        .photo-btn:hover { background: #8B3FCC; }
        .logout-btn {
            background: #ef4444;
            margin-top: 24px;
        }
        .logout-btn:hover { background: #dc2626; }
        
        /* Bottom Nav */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
        }
        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 24px;
        }
        .nav-btn.active { color: #9D4EDD; }
        .nav-label {
            font-size: 12px;
            margin-top: 4px;
        }
        
        /* Empty State */
        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #999;
            padding: 24px;
        }
        .empty-icon { font-size: 64px; margin-bottom: 16px; }
        
        /* Utilities */
        .flex-col { display: flex; flex-direction: column; }
        .h-100 { height: 100vh; }
        .text-center { text-align: center; }
        .mt-2 { margin-top: 8px; }
        .mb-4 { margin-bottom: 16px; }
        .font-bold { font-weight: bold; }
        .text-gray { color: #666; }
    </style>
</head>
<body>
    <!-- Splash Screen -->
    <div id="splash" class="screen active">
        <div class="logo">ü™É</div>
        <h1 class="font-bold" style="margin-top: 16px; font-size: 32px;">BUMER</h1>
        <p class="text-gray mt-2">Conecte-se de um jeito novo</p>
    </div>

    <!-- Signup -->
    <div id="signup" class="screen">
        <div class="logo" style="margin-bottom: 24px;">ü™É</div>
        <h1 class="font-bold mb-4" style="font-size: 24px;">Bem-vindo ao Bumer</h1>
        <input type="text" id="nameInput" placeholder="Digite seu nome" maxlength="50">
        <button class="btn" onclick="handleSignup()">Entrar no Bumer</button>
    </div>

    <!-- Profile -->
    <div id="profile" class="screen flex-col h-100">
        <div class="header gradient">
            <button style="background:none;border:none;color:white;font-size:24px;cursor:pointer;" onclick="showScreen('radar')">‚Üê</button>
            <span class="header-title white">Meu Perfil</span>
            <div style="width:24px;"></div>
        </div>
        <div class="profile-content">
            <div class="profile-photo-container">
                <div id="profilePhotoDisplay"></div>
                <label class="photo-btn">
                    üì∑
                    <input type="file" accept="image/*" onchange="handlePhotoUpload(event)" style="display:none;">
                </label>
            </div>
            <h2 class="font-bold" style="font-size: 24px;" id="profileName">Nome</h2>
            <p class="text-gray mt-2">Membro desde hoje</p>
            <button class="btn logout-btn" onclick="logout()">Sair da Conta</button>
        </div>
    </div>

    <!-- Radar -->
    <div id="radar" class="screen flex-col h-100">
        <div class="header">
            <h1 class="header-title">BUMER</h1>
            <button style="background:none;border:none;font-size:28px;cursor:pointer;" onclick="showScreen('profile')">üë§</button>
        </div>
        <div class="radar-grid" id="radarGrid"></div>
        <div class="bottom-nav">
            <button class="nav-btn active" onclick="showScreen('radar')">
                <span>üß≠</span>
                <span class="nav-label">Radar</span>
            </button>
            <button class="nav-btn" onclick="showScreen('conversations')">
                <span>üí¨</span>
                <span class="nav-label">Conversas</span>
            </button>
            <button class="nav-btn" onclick="showScreen('vault')">
                <span>üì¶</span>
                <span class="nav-label">Ba√∫</span>
            </button>
        </div>
    </div>

    <!-- Conversations -->
    <div id="conversations" class="screen flex-col h-100">
        <div class="header">
            <h1 class="font-bold" style="font-size: 24px;">Conversas</h1>
        </div>
        <div class="conv-list" id="convList"></div>
        <div class="bottom-nav">
            <button class="nav-btn" onclick="showScreen('radar')">
                <span>üß≠</span>
                <span class="nav-label">Radar</span>
            </button>
            <button class="nav-btn active" onclick="showScreen('conversations')">
                <span>üí¨</span>
                <span class="nav-label">Conversas</span>
            </button>
            <button class="nav-btn" onclick="showScreen('vault')">
                <span>üì¶</span>
                <span class="nav-label">Ba√∫</span>
            </button>
        </div>
    </div>

    <!-- Chat -->
    <div id="chat" class="screen flex-col h-100">
        <div class="header gradient">
            <div style="display:flex;align-items:center;gap:12px;">
                <button style="background:none;border:none;color:white;font-size:24px;cursor:pointer;" onclick="showScreen('conversations')">‚Üê</button>
                <div id="chatUserAvatar"></div>
                <span class="header-title white" id="chatUserName">Usu√°rio</span>
            </div>
            <button style="background:none;border:none;font-size:28px;cursor:pointer;" onclick="sendToVault()">ü™É</button>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input">
            <input type="text" id="messageInput" placeholder="Digite uma mensagem...">
            <button class="send-btn" onclick="sendMessage()">‚úàÔ∏è</button>
        </div>
    </div>

    <!-- Vault -->
    <div id="vault" class="screen flex-col h-100">
        <div class="header">
            <div>
                <h1 class="font-bold" style="font-size: 24px;">Meu Ba√∫</h1>
                <p style="font-size: 12px; color: #999;">Pessoas que voc√™ quis dar um tempo</p>
            </div>
        </div>
        <div class="vault-list" id="vaultList"></div>
        <div class="bottom-nav">
            <button class="nav-btn" onclick="showScreen('radar')">
                <span>üß≠</span>
                <span class="nav-label">Radar</span>
            </button>
            <button class="nav-btn" onclick="showScreen('conversations')">
                <span>üí¨</span>
                <span class="nav-label">Conversas</span>
            </button>
            <button class="nav-btn active" onclick="showScreen('vault')">
                <span>üì¶</span>
                <span class="nav-label">Ba√∫</span>
            </button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, query, where, getDocs, onSnapshot, orderBy, doc, updateDoc, deleteDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyA4IihfRLNToQ04yZVEamFDiz4mMwMVViE",
            authDomain: "bumer-app-6eee9.firebaseapp.com",
            projectId: "bumer-app-6eee9",
            storageBucket: "bumer-app-6eee9.firebasestorage.app",
            messagingSenderId: "574459437994",
            appId: "1:574459437994:web:e74ee1662e287866eac1d3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        window.db = db;
        window.firestoreModules = { collection, addDoc, query, where, getDocs, onSnapshot, orderBy, doc, updateDoc, deleteDoc, serverTimestamp };
    </script>

    <script>
        let currentUser = null;
        let currentChat = null;
        let usersListener = null;
        let connectionsListener = null;
        let messagesListener = null;

        // Utility Functions
        function getAvatarColor(name) {
            const colors = ['#FF8C42', '#FF4D8F', '#9D4EDD', '#4CC9F0', '#06FFA5'];
            const index = (name?.charCodeAt(0) || 0) % colors.length;
            return colors[index];
        }

        function getInitials(name) {
            if (!name) return '?';
            const parts = name.split(' ');
            if (parts.length >= 2) return `${parts[0][0]}${parts[1][0]}`.toUpperCase();
            return name.substring(0, 2).toUpperCase();
        }

        function showScreen(screenName) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenName).classList.add('active');
            
            if (screenName === 'radar') loadUsers();
            if (screenName === 'conversations') loadConversations();
            if (screenName === 'vault') loadVault();
            if (screenName === 'profile') updateProfileDisplay();
        }

        function updateProfileDisplay() {
            const photo = localStorage.getItem('bumerProfilePhoto');
            const display = document.getElementById('profilePhotoDisplay');
            
            if (photo) {
                display.innerHTML = `<img src="${photo}" class="profile-photo">`;
            } else {
                const color = getAvatarColor(currentUser?.name);
                const initials = getInitials(currentUser?.name);
                display.innerHTML = `<div class="profile-avatar" style="background:${color}">${initials}</div>`;
            }
            
            document.getElementById('profileName').textContent = currentUser?.name || 'Nome';
        }

        // Splash Screen
        setTimeout(() => {
            const savedUser = localStorage.getItem('bumerUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showScreen('radar');
            } else {
                showScreen('signup');
            }
        }, 2000);

        // Signup
        async function handleSignup() {
            const name = document.getElementById('nameInput').value.trim();
            if (!name) {
                alert('Por favor, digite seu nome!');
                return;
            }

            const { collection, addDoc, serverTimestamp } = window.firestoreModules;
            const photo = localStorage.getItem('bumerProfilePhoto');
            
            try {
                const docRef = await addDoc(collection(window.db, 'users'), {
                    name,
                    profilePhoto: photo || null,
                    createdAt: serverTimestamp()
                });
                
                currentUser = { id: docRef.id, name, profilePhoto: photo };
                localStorage.setItem('bumerUser', JSON.stringify(currentUser));
                showScreen('radar');
            } catch (error) {
                console.error('Erro ao cadastrar:', error);
                alert('Erro ao cadastrar. Tente novamente.');
            }
        }

        // Photo Upload
        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onloadend = async () => {
                const photoData = reader.result;
                localStorage.setItem('bumerProfilePhoto', photoData);
                
                if (currentUser) {
                    const { doc, updateDoc } = window.firestoreModules;
                    try {
                        await updateDoc(doc(window.db, 'users', currentUser.id), {
                            profilePhoto: photoData
                        });
                        currentUser.profilePhoto = photoData;
                        localStorage.setItem('bumerUser', JSON.stringify(currentUser));
                        updateProfileDisplay();
                    } catch (error) {
                        console.error('Erro ao atualizar foto:', error);
                    }
                }
            };
            reader.readAsDataURL(file);
        }

        // Load Users (Radar)
        function loadUsers() {
            if (!currentUser) return;
            
            const { collection, onSnapshot } = window.firestoreModules;
            
            if (usersListener) usersListener();
            
            usersListener = onSnapshot(collection(window.db, 'users'), (snapshot) => {
                const users = snapshot.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .filter(user => user.id !== currentUser.id);
                
                const grid = document.getElementById('radarGrid');
                grid.innerHTML = '';
                
                users.forEach(user => {
                    const card = document.createElement('div');
                    card.className = 'user-card';
                    card.onclick = () => handleConnect(user);
                    
                    let photoHTML;
                    if (user.profilePhoto) {
                        photoHTML = `<img src="${user.profilePhoto}" class="user-photo">`;
                    } else {
                        const color = getAvatarColor(user.name);
                        const initials = getInitials(user.name);
                        photoHTML = `<div class="user-avatar" style="background:${color}">${initials}</div>`;
                    }
                    
                    card.innerHTML = `
                        ${photoHTML}
                        <div class="user-info">
                            <p class="font-bold">${user.name}</p>
                            <div class="user-icons">
                                <div class="icon-dot" style="background:#06FFA5"></div>
                                <div class="icon-dot" style="background:#FFD700"></div>
                                <div class="icon-dot" style="background:#4CC9F0"></div>
                                <div class="icon-dot" style="background:#FF4D8F"></div>
                            </div>
                        </div>
                    `;
                    grid.appendChild(card);
                });
            });
        }

        // Connect with User
        async function handleConnect(targetUser) {
            const { collection, query, where, getDocs, addDoc, serverTimestamp } = window.firestoreModules;
            
            try {
                // Check existing connection
                const q = query(
                    collection(window.db, 'connections'),
                    where('users', 'array-contains', currentUser.id)
                );
                const snapshot = await getDocs(q);
                
                let existingConn = null;
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    if (data.users.includes(targetUser.id)) {
                        existingConn = { id: doc.id, ...data };
                    }
                });
                
                if (existingConn && existingConn.status === 'active') {
                    currentChat = { ...existingConn, otherUser: targetUser };
                    showScreen('chat');
                    loadChat();
                    return;
                }
                
                // Create new connection
                const docRef = await addDoc(collection(window.db, 'connections'), {
                    users: [currentUser.id, targetUser.id],
                    status: 'active',
                    vault_added_by: null,
                    vault_expires_at: null,
                    createdAt: serverTimestamp()
                });
                
                currentChat = {
                    id: docRef.id,
                    users: [currentUser.id, targetUser.id],
                    status: 'active',
                    otherUser: targetUser
                };
                
                showScreen('chat');
                loadChat();
            } catch (error) {
                console.error('Erro ao conectar:', error);
                alert('Erro ao conectar. Tente novamente.');
            }
        }

        // Load Conversations
        function loadConversations() {
            if (!currentUser) return;
            
            const { collection, query, where, onSnapshot, getDocs } = window.firestoreModules;
            
            if (connectionsListener) connectionsListener();
            
            const q = query(
                collection(window.db, 'connections'),
                where('users', 'array-contains', currentUser.id)
            );
            
            connectionsListener = onSnapshot(q, async (snapshot) => {
                const connections = snapshot.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .filter(conn => conn.status === 'active');
                
                const list = document.getElementById('convList');
                
                if (connections.length === 0) {
                    list.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üí¨</div>
                            <p>Nenhuma conversa ainda</p>
                            <p style="font-size:14px;margin-top:8px;">V√° ao Radar para conectar!</p>
                        </div>
                    `;
                    return;
                }
                
                // Get all users
                const usersSnapshot = await getDocs(collection(window.db, 'users'));
                const users = {};
                usersSnapshot.docs.forEach(doc => {
                    users[doc.id] = { id: doc.id, ...doc.data() };
                });
                
                list.innerHTML = '';
                connections.forEach(conn => {
                    const otherUserId = conn.users.find(id => id !== currentUser.id);
                    const otherUser = users[otherUserId];
                    if (!otherUser) return;
                    
                    const item = document.createElement('div');
                    item.className = 'conv-item';
                    item.onclick = () => {
                        currentChat = { ...conn, otherUser };
                        showScreen('chat');
                        loadChat();
                    };
                    
                    let avatarHTML;
                    if (otherUser.profilePhoto) {
                        avatarHTML = `<img src="${otherUser.profilePhoto}" class="conv-avatar">`;
                    } else {
                        const color = getAvatarColor(otherUser.name);
                        const initials = getInitials(otherUser.name);
                        avatarHTML = `<div class="avatar-circle" style="background:${color}">${initials}</div>`;
                    }
                    
                    item.innerHTML = `
                        ${avatarHTML}
                        <div>
                            <p class="font-bold">${otherUser.name}</p>
                            <p class="text-gray" style="font-size:14px;">Toque para conversar</p>
                        </div>
                    `;
                    list.appendChild(item);
                });
            });
        }

        // Load Chat
        function loadChat() {
            if (!currentChat) return;
            
            const { collection, query, where, orderBy, onSnapshot } = window.firestoreModules;
            
            // Update header
            const otherUser = currentChat.otherUser;
            document.getElementById('chatUserName').textContent = otherUser.name;
            
            let avatarHTML;
            if (otherUser.profilePhoto) {
                avatarHTML = `<img src="${otherUser.profilePhoto}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;">`;
            } else {
                const color = getAvatarColor(otherUser.name);
                const initials = getInitials(otherUser.name);
                avatarHTML = `<div style="width:40px;height:40px
